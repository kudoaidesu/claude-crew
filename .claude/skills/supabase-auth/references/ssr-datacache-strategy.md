# SSR + Data Cache ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æˆ¦ç•¥

## ğŸ“‹ æ¦‚è¦

ã‚¨ã‚¤ã‚µãƒ¼ãƒãƒƒãƒ—ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€**SSRï¼ˆServer-Side Renderingï¼‰ã¨Data Cacheã‚’çµ„ã¿åˆã‚ã›ãŸãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æˆ¦ç•¥**ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚

### ğŸ¯ åŸºæœ¬æ–¹é‡

```
âœ… ãƒšãƒ¼ã‚¸ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°: SSRï¼ˆforce-dynamicï¼‰â† ãƒ˜ãƒƒãƒ€ãƒ¼èªè¨¼çŠ¶æ…‹ã‚’æ¯å›åæ˜ 
âœ… å…¬é–‹ãƒ‡ãƒ¼ã‚¿: Data Cacheï¼ˆunstable_cache + revalidate + tagsï¼‰
âœ… èªè¨¼ãƒ‡ãƒ¼ã‚¿: æ¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆå–å¾—ï¼ˆno-storeï¼‰
âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ºæœ‰ãƒ‡ãƒ¼ã‚¿: æ¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆå–å¾—ï¼ˆno-storeï¼‰
```

### âš–ï¸ ISRã‚’ä½¿ã‚ãªã„ç†ç”±

| é …ç›® | ISR | SSR + Data Cache |
|------|-----|------------------|
| ãƒšãƒ¼ã‚¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥ | âœ… ã‚ã‚Šï¼ˆ5åˆ†ç­‰ï¼‰ | âŒ ãªã—ï¼ˆæ¯å›SSRï¼‰ |
| ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥ | âœ… ã‚ã‚Š | âœ… ã‚ã‚Š |
| ãƒ˜ãƒƒãƒ€ãƒ¼èªè¨¼ | âš ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã¦ãƒ•ãƒªãƒƒã‚«ãƒ¼ | âœ… æ¯å›æœ€æ–° |
| ç·¨é›†æ¨©é™åˆ¤å®š | âš ï¸ å¤ã„çŠ¶æ…‹ã®å¯èƒ½æ€§ | âœ… æ¯å›æœ€æ–° |
| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ | âš¡ æœ€é€Ÿï¼ˆTTFB: 20msï¼‰ | ğŸš€ é«˜é€Ÿï¼ˆTTFB: 200msï¼‰ |

**çµè«–**: ãƒ˜ãƒƒãƒ€ãƒ¼ãŒã™ã¹ã¦ã®ãƒšãƒ¼ã‚¸ã«ã‚ã‚‹ãŸã‚ã€**SSRã‚’ç¶­æŒ**ã—ãªãŒã‚‰Data Cacheã§å…¬é–‹ãƒ‡ãƒ¼ã‚¿ã‚’é«˜é€ŸåŒ–

---

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“ ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Next.js Edge Networkï¼ˆVercel CDNï¼‰      â”‚
â”‚  - é™çš„ã‚¢ã‚»ãƒƒãƒˆé…ä¿¡                       â”‚
â”‚  - ãƒšãƒ¼ã‚¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—ï¼ˆSSRï¼‰             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“ SSRå®Ÿè¡Œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Server Componentï¼ˆSSRï¼‰                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 1. èªè¨¼ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆno-storeï¼‰      â”‚  â”‚
â”‚  â”‚    - supabase.auth.getUser()      â”‚  â”‚
â”‚  â”‚    - get_user_auth_data()         â”‚  â”‚
â”‚  â”‚    æ¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ 200ms              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 2. å…¬é–‹ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆData Cacheï¼‰    â”‚  â”‚
â”‚  â”‚    - getAllEvents()               â”‚  â”‚
â”‚  â”‚    - getEventDetail()             â”‚  â”‚
â”‚  â”‚    ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆæ™‚ 5ms          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                         â”‚
â”‚  ä¸¦åˆ—å®Ÿè¡Œã§æœ€é©åŒ– âœ…                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“ ãƒ‡ãƒ¼ã‚¿å–å¾—
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Data Cacheï¼ˆNext.jså†…éƒ¨ï¼‰               â”‚
â”‚  - unstable_cache ã«ã‚ˆã‚‹å…±æœ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥   â”‚
â”‚  - revalidate: 60-3600ç§’               â”‚
â”‚  - tags: ['events', 'groups']          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹æ™‚ã®ã¿
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase Database                      â”‚
â”‚  - RLSæœ‰åŠ¹                              â”‚
â”‚  - åŒ¿å/èªè¨¼ã‚¢ã‚¯ã‚»ã‚¹åˆ†é›¢                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç‰¹æ€§

### ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼ˆå…¸å‹çš„ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰

```
ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹
  â†“
  â”œâ”€ 0-200ms: SSRå®Ÿè¡Œ
  â”‚   â”œâ”€ 0-200ms: èªè¨¼ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆä¸¦åˆ—ï¼‰
  â”‚   â””â”€ 0-5ms:   å…¬é–‹ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆä¸¦åˆ—ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆï¼‰
  â†“
  â””â”€ 200ms: HTMLç”Ÿæˆå®Œäº† â†’ ãƒ¬ã‚¹ãƒãƒ³ã‚¹
```

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡ï¼ˆæƒ³å®šï¼‰

| ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ— | ãƒ’ãƒƒãƒˆç‡ | TTFBï¼ˆãƒ’ãƒƒãƒˆæ™‚ï¼‰ | TTFBï¼ˆãƒŸã‚¹æ™‚ï¼‰ |
|-------------|---------|----------------|---------------|
| ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ | 95% | 200ms | 400ms |
| ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´° | 90% | 200ms | 500ms |
| å›£ä½“è©³ç´° | 95% | 200ms | 450ms |

---

## ğŸ”§ å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

### 1. ãƒšãƒ¼ã‚¸ãƒ¬ãƒ™ãƒ«è¨­å®šï¼ˆå¿…é ˆï¼‰

ã™ã¹ã¦ã®ãƒšãƒ¼ã‚¸ã§ä»¥ä¸‹ã‚’è¨­å®šï¼š

```typescript
// app/events/[id]/page.tsx
/**
 * ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ï¼ˆSSR + Data Cache ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ï¼‰:
 * - ãƒšãƒ¼ã‚¸ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°: SSRï¼ˆforce-dynamicï¼‰â† ãƒ˜ãƒƒãƒ€ãƒ¼èªè¨¼çŠ¶æ…‹ + ç·¨é›†æ¨©é™åˆ¤å®šã®ãŸã‚
 * - å…¬é–‹ãƒ‡ãƒ¼ã‚¿: Data Cacheï¼ˆgetEventDetail ã¯unstable_cacheã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿ï¼‰
 * - èªè¨¼ãƒ‡ãƒ¼ã‚¿: æ¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆå–å¾—ï¼ˆgetCurrentUser, canEditEventï¼‰
 */
export const dynamic = 'force-dynamic';
export const revalidate = 0;
```

### 2. ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•°ï¼ˆå…¬é–‹ãƒ‡ãƒ¼ã‚¿ï¼‰

#### ç¾åœ¨ã®å®Ÿè£…ï¼šSupabase SDK + unstable_cache

```typescript
// lib/data/events.ts
import { unstable_cache } from 'next/cache'
import { createAnonymousServerClient } from '@/lib/supabase/server'

export const getEventDetail = unstable_cache(
  async (id: string) => {
    const supabase = createAnonymousServerClient()
    const { data } = await supabase
      .from('events_v2')
      .select(`
        *,
        event_groups (*, groups(*)),
        event_images (*)
      `)
      .eq('id', id)
      .single()
    return data
  },
  ['event-detail'],
  {
    revalidate: 300,  // 5åˆ†ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    tags: ['events', 'event-detail'],
  }
)
```

**ãªãœ `unstable_cache` ã‚’ä½¿ã†ã®ã‹ï¼Ÿ**

1. **Supabase SDKã®å†…éƒ¨fetch**ã¯**Next.js Data Cacheã«è‡ªå‹•ã§ä¹—ã‚‰ãªã„**
2. è¤‡é›‘ãªã‚¯ã‚¨ãƒªï¼ˆJOINã€ãƒã‚¹ãƒˆï¼‰ãŒå¤šãã€fetchã§æ›¸ãã¨å¯èª­æ€§ãŒä½ä¸‹
3. å‹å®‰å…¨æ€§ã‚’ç¶­æŒã—ãŸã„ï¼ˆSupabaseå‹å®šç¾©ã‚’æ´»ç”¨ï¼‰

**ä»£æ›¿æ¡ˆï¼šfetchç›´æ¥ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªã‚¯ã‚¨ãƒªå‘ã‘ï¼‰**

```typescript
// ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¯ã‚¨ãƒªãªã‚‰fetchã‚‚é¸æŠè‚¢
export async function getEventIds() {
  const res = await fetch(
    `${process.env.NEXT_PUBLIC_SUPABASE_URL}/rest/v1/events_v2?select=id`,
    {
      headers: {
        apikey: process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
      },
      next: {
        revalidate: 3600,
        tags: ['events'],
      },
    }
  )
  return res.json()
}
```

**åˆ¤æ–­åŸºæº–**:
- **è¤‡é›‘ãªã‚¯ã‚¨ãƒªï¼ˆJOINã€ãƒã‚¹ãƒˆï¼‰**: Supabase SDK + `unstable_cache` â† ç¾åœ¨æ¡ç”¨
- **ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¯ã‚¨ãƒªï¼ˆå˜ä¸€ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰**: `fetch` + `next.revalidate`

### 3. èªè¨¼ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆæ¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰

```typescript
// app/layout.tsx
export default async function RootLayout({ children }) {
  // èªè¨¼ãƒ‡ãƒ¼ã‚¿ã¨å…¬é–‹ãƒ‡ãƒ¼ã‚¿ã‚’ä¸¦åˆ—å–å¾—
  const [authResult] = await Promise.all([
    // èªè¨¼ãƒ‡ãƒ¼ã‚¿: æ¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆno-storeï¼‰
    (async () => {
      const supabase = await createClient()
      const { data: { user } } = await supabase.auth.getUser()
      // æ¨©é™ãƒ‡ãƒ¼ã‚¿å–å¾—...
      return { user, roles, permissions }
    })(),
    // å°†æ¥çš„ã«å…¬é–‹ãƒ‡ãƒ¼ã‚¿ã‚’ä¸¦åˆ—å–å¾—å¯èƒ½
  ])

  const { user, roles, permissions } = authResult
  // ...
}
```

### 4. å…¬é–‹ãƒ‡ãƒ¼ã‚¿ã®çµ±ä¸€å–å¾—ï¼ˆæ¨å¥¨ï¼‰

```typescript
// lib/public-data.ts
import { unstable_cache } from 'next/cache'

export const getPublicNavData = unstable_cache(
  async () => {
    // å…±é€šãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿
  },
  ['public-nav'],
  { revalidate: 3600, tags: ['public-nav'] }
)
```

---

## ğŸ¯ ãƒ‡ãƒ¼ã‚¿åˆ†é¡ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

### âœ… Data Cacheï¼ˆunstable_cacheï¼‰ã‚’ä½¿ã†ã¹ããƒ‡ãƒ¼ã‚¿

1. **å…¬é–‹ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±**
   - ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ï¼ˆ`getAllEvents`ï¼‰
   - ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ï¼ˆ`getEventDetail`ï¼‰
   - æ—¥ä»˜åˆ¥ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆ`getEventsByDate`ï¼‰

2. **å…¬é–‹å›£ä½“æƒ…å ±**
   - å›£ä½“ä¸€è¦§ï¼ˆ`getGroups`ï¼‰
   - å›£ä½“è©³ç´°ï¼ˆ`getGroupDetails`ï¼‰

3. **å…¬é–‹çµ±è¨ˆãƒ‡ãƒ¼ã‚¿**
   - ã‚¤ãƒ™ãƒ³ãƒˆæ•°ã€å›£ä½“æ•°
   - ã‚«ãƒ†ã‚´ãƒªåˆ¥é›†è¨ˆ

4. **å…±é€šãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³**
   - ãƒ˜ãƒƒãƒ€ãƒ¼/ãƒ•ãƒƒã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿
   - ã‚«ãƒ†ã‚´ãƒªãƒªã‚¹ãƒˆ

### âŒ Data Cacheã‚’ä½¿ã‚ãªã„ï¼ˆæ¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆå–å¾—ï¼‰ãƒ‡ãƒ¼ã‚¿

1. **èªè¨¼æƒ…å ±**
   - `supabase.auth.getUser()`
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ï¼ˆ`get_user_auth_data`ï¼‰

2. **ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ºæœ‰ãƒ‡ãƒ¼ã‚¿**
   - ãƒã‚¤ãƒšãƒ¼ã‚¸æƒ…å ±
   - ç·¨é›†æ¨©é™åˆ¤å®š

3. **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿**
   - ç”³è«‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
   - é€šçŸ¥

---

## ğŸ”„ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ï¼ˆrevalidationï¼‰

### ã‚¿ã‚°ãƒ™ãƒ¼ã‚¹ç„¡åŠ¹åŒ–

```typescript
// actions/event-actions.ts
import { invalidateEventCache } from '@/lib/cache'

export async function updateEvent(id: string, data: EventData) {
  // ã‚¤ãƒ™ãƒ³ãƒˆæ›´æ–°å‡¦ç†...

  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–
  await invalidateEventCache(id)
  // â†’ tags: ['events', 'event-123'] ãŒç„¡åŠ¹åŒ–ã•ã‚Œã‚‹
}
```

### ãƒ‘ã‚¹ãƒ™ãƒ¼ã‚¹ç„¡åŠ¹åŒ–

```typescript
import { revalidatePath } from 'next/cache'

export async function createEvent(data: EventData) {
  // ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆå‡¦ç†...

  // é–¢é€£ãƒšãƒ¼ã‚¸ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–
  revalidatePath('/', 'layout')  // ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸
  revalidatePath('/date/[date]', 'page')  // æ—¥ä»˜åˆ¥ä¸€è¦§
}
```

---

## ğŸ“ˆ æœŸå¾…åŠ¹æœ

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„

| æŒ‡æ¨™ | æ”¹å–„å‰ | æ”¹å–„å¾Œ | å‰Šæ¸›ç‡ |
|------|--------|--------|--------|
| **å…¬é–‹ãƒ‡ãƒ¼ã‚¿DBå–å¾—** | æ¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆ99% | **99%å‰Šæ¸›** |
| **TTFB** | 400ms | 200-250ms | **40%å‰Šæ¸›** |
| **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è² è·** | 100% | 5-10% | **90%å‰Šæ¸›** |

### ã‚³ã‚¹ãƒˆå‰Šæ¸›

```
æƒ³å®šã‚¢ã‚¯ã‚»ã‚¹: 10,000 PV/æ—¥

DB ã‚¯ã‚¨ãƒªå‰Šæ¸›:
- æ”¹å–„å‰: 10,000å›/æ—¥ Ã— 300ms = 50åˆ†/æ—¥
- æ”¹å–„å¾Œ: 500å›/æ—¥ Ã— 300ms = 2.5åˆ†/æ—¥
- å‰Šæ¸›ç‡: 95%

Supabase ã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼ˆæƒ³å®šï¼‰:
- ç„¡æ–™æ ã§ã®ãƒãƒ¼ã‚¸ãƒ³æ‹¡å¤§
- ã‚¹ã‚±ãƒ¼ãƒ«æ™‚ã®ã‚³ã‚¹ãƒˆåŠ¹ç‡å‘ä¸Š
```

---

## âš ï¸ æ³¨æ„äº‹é …

### 1. ãƒšãƒ¼ã‚¸ã¯SSRã‚’ç¶­æŒ

```typescript
// âŒ ISRã«å¤‰æ›´ã—ãªã„
export const revalidate = 300;  // ã“ã‚Œã¯ã‚„ã‚‰ãªã„

// âœ… SSRã‚’ç¶­æŒ
export const dynamic = 'force-dynamic';
export const revalidate = 0;
```

**ç†ç”±**: ãƒ˜ãƒƒãƒ€ãƒ¼èªè¨¼çŠ¶æ…‹ã‚’æ¯å›åæ˜ ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚

### 2. ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•°ã®åˆ†é›¢

```typescript
// âŒ ãƒšãƒ¼ã‚¸å†…ã§ç›´æ¥Supabaseã‚¢ã‚¯ã‚»ã‚¹
export default async function Page() {
  const supabase = createClient()
  const { data } = await supabase.from('events').select('*')
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œãªã„ï¼
}

// âœ… ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•°ã‚’åˆ†é›¢ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥
export default async function Page() {
  const events = await getAllEvents()  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹
}
```

### 3. åŒ¿å/èªè¨¼ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä½¿ã„åˆ†ã‘

```typescript
// âœ… å…¬é–‹ãƒ‡ãƒ¼ã‚¿: åŒ¿åã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
import { createAnonymousServerClient } from '@/lib/supabase/server'
const supabase = createAnonymousServerClient()

// âœ… èªè¨¼ãƒ‡ãƒ¼ã‚¿: èªè¨¼ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
import { createServerClient } from '@/lib/supabase/server'
const supabase = await createServerClient()
```

---

## ğŸ” ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Q1: ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œãªã„

**åŸå› **: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå¤ã„
**è§£æ±ºç­–**: Server Actionå®Ÿè¡Œå¾Œã« `revalidateTag` ã‚’å‘¼ã¶

```typescript
await updateEvent(id, data)
await invalidateEventCache(id)  // â† ã“ã‚ŒãŒå¿…é ˆ
```

### Q2: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒæ”¹å–„ã—ãªã„

**åŸå› **: ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•°ãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã¦ã„ãªã„
**ãƒã‚§ãƒƒã‚¯**: `unstable_cache` ã§ãƒ©ãƒƒãƒ—ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

```typescript
// âŒ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—
export async function getEvents() { /* ... */ }

// âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚ã‚Š
export const getEvents = unstable_cache(
  async () => { /* ... */ },
  ['events'],
  { revalidate: 60 }
)
```

### Q3: ãƒ˜ãƒƒãƒ€ãƒ¼ã®èªè¨¼çŠ¶æ…‹ãŒå¤ã„

**åŸå› **: ãƒšãƒ¼ã‚¸ãŒISRã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã¦ã„ã‚‹
**è§£æ±ºç­–**: `force-dynamic` ã‚’è¨­å®š

```typescript
export const dynamic = 'force-dynamic';
```

---

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [Next.js Data Cacheå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://nextjs.org/docs/app/building-your-application/caching#data-cache)
- [Supabaseèªè¨¼ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹](./Supabaseèªè¨¼ã®æ³¨æ„ç‚¹ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹.md)
- [ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã‚¬ã‚¤ãƒ‰](./ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹.md)

---

## ğŸ“ å¤‰æ›´å±¥æ­´

| æ—¥ä»˜ | å¤‰æ›´å†…å®¹ |
|------|---------|
| 2025-01-12 | åˆç‰ˆä½œæˆï¼šSSR + Data Cacheæˆ¦ç•¥ã®ç¢ºç«‹ |
