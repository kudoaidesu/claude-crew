<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Claude Code</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#1e1e2e;--surface:#252536;--surface-hover:#2a2a3d;
  --border:#333346;--border-light:#3e3e56;
  --text:#cdd6f4;--text-bright:#fff;--muted:#6c7086;
  --accent:#c084fc;--accent-dim:rgba(192,132,252,.12);--accent-border:rgba(192,132,252,.25);
  --user-bg:#2a2a3d;--user-border:#3e3e56;
  --warning:#f9e2af;--warning-bg:rgba(249,226,175,.08);
  --danger:#f38ba8;--danger-bg:rgba(243,139,168,.08);
  --success:#a6e3a1;--success-bg:rgba(166,227,161,.08);
  --diff-add:rgba(166,227,161,.12);--diff-del:rgba(243,139,168,.12);
  --diff-add-text:#a6e3a1;--diff-del-text:#f38ba8;
  --font-sans:-apple-system,system-ui,'Segoe UI','Helvetica Neue',sans-serif;
  --font-mono:'SF Mono',Menlo,'Cascadia Code','JetBrains Mono',Consolas,monospace;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--font-sans);font-size:14px;line-height:1.6}
body{display:flex;flex-direction:column;height:100dvh}

/* ‚îÄ‚îÄ „Éò„ÉÉ„ÉÄ„Éº ‚îÄ‚îÄ */
.header{display:flex;align-items:center;gap:8px;padding:10px 16px;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0}
.header-logo{display:flex;align-items:center;gap:6px;color:var(--accent);font-weight:700;font-size:13px;font-family:var(--font-mono)}
.header-logo svg{width:18px;height:18px;fill:currentColor}
.header-spacer{flex:1}
.header-btn{background:none;border:1px solid var(--border);color:var(--muted);border-radius:6px;padding:4px 10px;font-size:12px;font-family:var(--font-mono);cursor:pointer;display:flex;align-items:center;gap:4px;transition:all .15s}
.header-btn:hover{color:var(--text);border-color:var(--border-light);background:var(--surface-hover)}
.header-btn.active{color:var(--accent);border-color:var(--accent-border)}
.model-select{background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-size:12px;font-family:var(--font-mono);cursor:pointer}
.model-select:focus{outline:none;border-color:var(--accent)}

/* ‚îÄ‚îÄ „É°„ÉÉ„Çª„Éº„Ç∏„Ç®„É™„Ç¢ ‚îÄ‚îÄ */
.messages{flex:1;overflow-y:auto;padding:16px;-webkit-overflow-scrolling:touch;display:flex;flex-direction:column;gap:16px}

/* ‚îÄ‚îÄ „É¶„Éº„Ç∂„Éº„É°„ÉÉ„Çª„Éº„Ç∏ ‚îÄ‚îÄ */
.msg.user{display:flex;justify-content:flex-end}
.msg.user .bubble{background:var(--user-bg);border:1px solid var(--user-border);border-radius:12px 12px 2px 12px;padding:10px 14px;max-width:85%;white-space:pre-wrap;word-break:break-word;font-size:14px;line-height:1.5;color:var(--text-bright)}

/* ‚îÄ‚îÄ „Ç¢„Ç∑„Çπ„Çø„É≥„Éà„É°„ÉÉ„Çª„Éº„Ç∏ ‚îÄ‚îÄ */
.msg.assistant{display:flex;flex-direction:column;gap:8px}
.msg.assistant .content{color:var(--text);word-break:break-word;font-size:14px;line-height:1.7}

/* ‚îÄ‚îÄ „Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥ ‚îÄ‚îÄ */
.msg.assistant .content h1{font-size:20px;font-weight:700;margin:16px 0 8px;color:var(--text-bright)}
.msg.assistant .content h2{font-size:17px;font-weight:700;margin:14px 0 6px;color:var(--text-bright)}
.msg.assistant .content h3{font-size:15px;font-weight:700;margin:12px 0 4px;color:var(--text-bright)}
.msg.assistant .content p{margin:6px 0}
.msg.assistant .content ul,.msg.assistant .content ol{padding-left:20px;margin:6px 0}
.msg.assistant .content li{margin:2px 0}
.msg.assistant .content li::marker{color:var(--muted)}
.msg.assistant .content strong{color:var(--text-bright);font-weight:600}
.msg.assistant .content em{color:var(--muted);font-style:italic}
.msg.assistant .content hr{border:none;border-top:1px solid var(--border);margin:12px 0}
.msg.assistant .content a{color:var(--accent);text-decoration:none}
.msg.assistant .content a:hover{text-decoration:underline}

/* ‚îÄ‚îÄ „Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØ ‚îÄ‚îÄ */
.msg.assistant .content pre{position:relative;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px 14px;overflow-x:auto;margin:8px 0;font-size:13px;line-height:1.5}
.msg.assistant .content code{font-family:var(--font-mono);font-size:13px}
.msg.assistant .content p code,
.msg.assistant .content li code{background:rgba(192,132,252,.12);color:var(--accent);padding:2px 6px;border-radius:4px;font-size:12px}
.msg.assistant .content pre code{background:none;padding:0;border-radius:0;font-size:13px;color:var(--text)}
.code-copy-btn{position:absolute;top:8px;right:8px;background:var(--surface);color:var(--muted);border:1px solid var(--border);border-radius:4px;padding:2px 8px;font-size:11px;font-family:var(--font-mono);cursor:pointer;opacity:0;transition:opacity .15s}
pre:hover .code-copy-btn{opacity:1}
.code-copy-btn:hover{color:var(--accent);border-color:var(--accent-border)}
.code-copy-btn.copied{color:var(--success);border-color:var(--success)}

/* ‚îÄ‚îÄ „ÉÜ„Éº„Éñ„É´ ‚îÄ‚îÄ */
.msg.assistant .content table{border-collapse:collapse;width:100%;margin:8px 0;font-size:13px;font-family:var(--font-mono)}
.msg.assistant .content th{background:var(--surface);color:var(--text-bright);font-weight:600;text-align:left;padding:6px 10px;border:1px solid var(--border)}
.msg.assistant .content td{padding:6px 10px;border:1px solid var(--border)}
.msg.assistant .content tr:nth-child(even) td{background:var(--surface)}

/* ‚îÄ‚îÄ ÂºïÁî® ‚îÄ‚îÄ */
.msg.assistant .content blockquote{border-left:3px solid var(--accent);padding:4px 12px;margin:8px 0;color:var(--muted);background:var(--accent-dim);border-radius:0 6px 6px 0}

/* ‚îÄ‚îÄ „ÉÑ„Éº„É´ÂÆüË°å„Éë„Éç„É´ ‚îÄ‚îÄ */
.tool-detail{margin:4px 0;border:1px solid var(--border);border-radius:8px;overflow:hidden;font-family:var(--font-mono);font-size:12px;background:var(--surface)}
.tool-detail-header{display:flex;align-items:center;gap:8px;padding:8px 12px;cursor:pointer;user-select:none;transition:background .1s}
.tool-detail-header:hover{background:var(--surface-hover)}
.tool-detail-header .tool-chevron{font-size:9px;color:var(--muted);transition:transform .15s;width:12px;text-align:center}
.tool-detail-header .tool-chevron.open{transform:rotate(90deg)}
.tool-detail-header .tool-icon-label{display:flex;align-items:center;gap:6px}
.tool-detail-header .tool-emoji{font-size:14px}
.tool-detail-header .tool-name{color:var(--accent);font-weight:600;font-size:12px}
.tool-detail-header .tool-file{color:var(--muted);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:11px}
.tool-detail-header .tool-status{font-size:10px;color:var(--success)}
.tool-detail-body{display:none;padding:10px 12px;background:var(--bg);border-top:1px solid var(--border);max-height:300px;overflow:auto;white-space:pre-wrap;word-break:break-all;color:var(--text);line-height:1.4;font-size:12px}
.tool-detail-body.open{display:block}

/* diff */
.diff-line{padding:1px 6px;font-family:var(--font-mono);font-size:12px}
.diff-add{background:var(--diff-add);color:var(--diff-add-text)}
.diff-del{background:var(--diff-del);color:var(--diff-del-text)}
.diff-hunk{color:var(--accent);font-weight:600;margin-top:4px;font-size:11px}

/* ‚îÄ‚îÄ Ë≠¶Âëä„Éê„ÉÉ„Ç∏ ‚îÄ‚îÄ */
.warning-badge{display:flex;align-items:center;gap:8px;background:var(--warning-bg);color:var(--warning);border:1px solid rgba(249,226,175,.2);border-radius:8px;padding:8px 12px;font-size:12px;margin:4px 0;font-family:var(--font-mono)}

/* ‚îÄ‚îÄ „Ç≥„Çπ„ÉàË°®Á§∫ ‚îÄ‚îÄ */
.meta{font-size:11px;color:var(--muted);margin-top:2px;display:flex;gap:12px;font-family:var(--font-mono)}

/* ‚îÄ‚îÄ ÂÖ•Âäõ„Ç®„É™„Ç¢ ‚îÄ‚îÄ */
.input-area{border-top:1px solid var(--border);background:var(--surface);padding:12px 16px;padding-bottom:calc(12px + env(safe-area-inset-bottom));flex-shrink:0}
.input-box{border:1px solid var(--border);border-radius:10px;background:var(--bg);overflow:hidden;transition:border-color .15s}
.input-box:focus-within{border-color:var(--accent-border)}
.input-box textarea{width:100%;background:transparent;color:var(--text);border:none;padding:10px 14px;font-size:14px;font-family:var(--font-sans);resize:none;min-height:40px;max-height:150px;line-height:1.4}
.input-box textarea:focus{outline:none}
.input-box textarea::placeholder{color:var(--muted)}
.input-footer{display:flex;align-items:center;gap:6px;padding:4px 8px 6px}
.input-footer .model-indicator{font-size:11px;color:var(--muted);font-family:var(--font-mono);flex:1}
.input-footer button{width:30px;height:30px;border:none;border-radius:6px;background:transparent;color:var(--muted);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .1s}
.input-footer button:hover{background:var(--accent-dim);color:var(--accent)}
.input-footer button:disabled{opacity:.3;cursor:not-allowed}
.input-footer button.send-btn{background:var(--accent);color:#1e1e2e;border-radius:6px}
.input-footer button.send-btn:hover{opacity:.9}
.input-footer button.send-btn:disabled{opacity:.3}
.input-footer button.abort-btn{display:none;background:var(--danger-bg);color:var(--danger)}
.input-footer button.abort-btn:hover{background:rgba(243,139,168,.2)}

/* ‚îÄ‚îÄ „É≠„Éº„Éá„Ç£„É≥„Ç∞ ‚îÄ‚îÄ */
.typing{display:flex;align-items:center;gap:6px;padding:8px 0;color:var(--muted);font-size:13px}
.typing-dots{display:flex;gap:3px}
.typing-dots span{width:5px;height:5px;background:var(--accent);border-radius:50%;animation:bounce .6s infinite alternate;opacity:.5}
.typing-dots span:nth-child(2){animation-delay:.2s}
.typing-dots span:nth-child(3){animation-delay:.4s}
@keyframes bounce{to{opacity:.15;transform:translateY(-3px)}}

/* ‚îÄ‚îÄ „Éâ„É≠„ÉØ„Éº ‚îÄ‚îÄ */
.drawer{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:10;display:none;backdrop-filter:blur(2px)}
.drawer.open{display:block}
.drawer-content{position:absolute;bottom:0;left:0;right:0;background:var(--surface);border-radius:14px 14px 0 0;padding:16px;padding-bottom:calc(16px + env(safe-area-inset-bottom));max-height:70vh;overflow-y:auto;border:1px solid var(--border)}

/* „Éâ„É≠„ÉØ„Éº„Çø„Éñ */
.drawer-tabs{display:flex;gap:0;margin-bottom:12px;border-bottom:1px solid var(--border)}
.drawer-tab{padding:8px 14px;font-size:13px;color:var(--muted);cursor:pointer;border:none;background:none;font-family:var(--font-sans);border-bottom:2px solid transparent;font-weight:500;transition:color .1s}
.drawer-tab:hover{color:var(--text)}
.drawer-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.drawer-tab-content{display:none}
.drawer-tab-content.active{display:block}

/* „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç¢„Ç§„ÉÜ„É† */
.project-item{display:flex;flex-direction:column;padding:10px 12px;border:1px solid var(--border);border-radius:8px;margin-bottom:6px;cursor:pointer;transition:all .1s}
.project-item:hover{border-color:var(--border-light);background:var(--surface-hover)}
.project-item.active{border-color:var(--accent-border);background:var(--accent-dim)}
.project-item .name{font-weight:600;font-size:13px;color:var(--text-bright)}
.project-item .path{font-size:11px;color:var(--muted);margin-top:2px;font-family:var(--font-mono)}

/* „Çª„ÉÉ„Ç∑„Éß„É≥„Ç¢„Ç§„ÉÜ„É† */
.session-item{display:flex;flex-direction:column;padding:10px 12px;border:1px solid var(--border);border-radius:8px;margin-bottom:6px;cursor:pointer;transition:all .1s}
.session-item:hover{border-color:var(--border-light);background:var(--surface-hover)}
.session-item.active{border-color:var(--accent-border);background:var(--accent-dim)}
.session-item .preview{font-size:13px;color:var(--text-bright);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.session-item .session-meta{display:flex;gap:8px;font-size:11px;color:var(--muted);margin-top:4px;font-family:var(--font-mono)}
.session-item .delete-session{align-self:flex-end;color:var(--danger);background:none;border:none;font-size:11px;cursor:pointer;padding:2px 6px;font-family:var(--font-mono);opacity:.6;transition:opacity .1s}
.session-item .delete-session:hover{opacity:1}
</style>
</head>
<body>

<div class="header">
  <div class="header-logo">
    <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
    <span id="title">claude-crew</span>
  </div>
  <div class="header-spacer"></div>
  <select id="model" class="model-select">
    <option value="sonnet">sonnet</option>
    <option value="opus">opus</option>
    <option value="haiku">haiku</option>
  </select>
  <button class="header-btn" id="historyBtn" onclick="openDrawer('sessions')" title="Sessions">&#128340; History</button>
  <button class="header-btn" onclick="openDrawer('projects')" title="Projects">&#9776;</button>
</div>

<div class="messages" id="messages"></div>

<div class="input-area">
  <div class="input-box">
    <textarea id="input" rows="1" placeholder="Ask Claude anything..." enterkeyhint="send"></textarea>
    <div class="input-footer">
      <span class="model-indicator" id="modelIndicator">sonnet</span>
      <button class="abort-btn" id="abort" onclick="abortCurrentStream()" title="Stop">&#9632;</button>
      <button class="send-btn" id="send" onclick="sendMessage()" title="Send (Enter)">&#9654;</button>
    </div>
  </div>
</div>

<div class="drawer" id="drawer" onclick="closeDrawer()">
  <div class="drawer-content" onclick="event.stopPropagation()">
    <div class="drawer-tabs">
      <button class="drawer-tab active" data-tab="projects" onclick="switchDrawerTab('projects')">Projects</button>
      <button class="drawer-tab" data-tab="sessions" onclick="switchDrawerTab('sessions')">Sessions</button>
    </div>
    <div id="projectsTab" class="drawer-tab-content active">
      <div id="projectList"></div>
    </div>
    <div id="sessionsTab" class="drawer-tab-content">
      <div id="sessionList"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked@15/marked.min.js"></script>
<script>
// --- State ---
let sessionId = null
let currentStreamId = null
let currentProject = null
let sending = false
const messagesEl = document.getElementById('messages')
const inputEl = document.getElementById('input')
const sendBtn = document.getElementById('send')
const abortBtn = document.getElementById('abort')
const modelIndicator = document.getElementById('modelIndicator')

// „ÉÑ„Éº„É´„Ç¢„Ç§„Ç≥„É≥„Éû„ÉÉ„Éó
const TOOL_ICONS = {
  Read: 'üìÑ', Write: '‚úèÔ∏è', Edit: '‚úèÔ∏è', Bash: 'üíª',
  Glob: 'üîç', Grep: 'üîç', WebFetch: 'üåê', WebSearch: 'üåê',
  Task: 'ü§ñ', TodoWrite: 'üìù', NotebookEdit: 'üìì',
}

// --- marked „Ç´„Çπ„Çø„É†„É¨„É≥„ÉÄ„É©„Éº ---
const renderer = new marked.Renderer()
renderer.code = function({ text, lang }) {
  const langLabel = lang ? esc(lang) : ''
  const escaped = esc(text)
  return `<pre><button class="code-copy-btn" onclick="copyCode(this)" data-testid="code-copy-btn">Copy</button><code class="language-${langLabel}">${escaped}</code></pre>`
}
marked.setOptions({ renderer, breaks: true })

// --- „Ç≥„Éº„Éâ„Ç≥„Éî„Éº ---
function copyCode(btn) {
  const code = btn.parentElement.querySelector('code')
  const text = code.textContent
  navigator.clipboard.writeText(text).then(() => {
    btn.textContent = 'Copied!'
    btn.classList.add('copied')
    setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied') }, 1500)
  }).catch(() => {
    const ta = document.createElement('textarea')
    ta.value = text
    document.body.appendChild(ta)
    ta.select()
    document.execCommand('copy')
    document.body.removeChild(ta)
    btn.textContent = 'Copied!'
    btn.classList.add('copied')
    setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied') }, 1500)
  })
}

// --- „É¢„Éá„É´ÈÅ∏Êäû ---
document.getElementById('model').addEventListener('change', (e) => {
  modelIndicator.textContent = e.target.value
})

// --- ÂàùÊúüÂåñ ---
async function init() {
  try {
    const res = await fetch('/api/projects', { credentials: 'include' })
    const projects = await res.json()
    renderProjectList(projects)
    if (!currentProject && projects.length > 0) selectProject(projects[0])
  } catch (e) {
    console.error('Failed to load projects:', e)
  }
}

function renderProjectList(projects) {
  const list = document.getElementById('projectList')
  list.innerHTML = ''
  projects.forEach(p => {
    const el = document.createElement('div')
    el.className = 'project-item' + (currentProject === p.localPath ? ' active' : '')
    el.innerHTML = `<span class="name">${esc(p.slug)}</span><span class="path">${esc(p.localPath)}</span>`
    el.onclick = () => { selectProject(p); closeDrawer() }
    list.appendChild(el)
  })
}

function selectProject(p) {
  currentProject = p.localPath
  sessionId = null
  document.getElementById('title').textContent = p.slug
}

// --- „Éâ„É≠„ÉØ„Éº ---
function openDrawer(tab) {
  document.getElementById('drawer').classList.add('open')
  if (tab) switchDrawerTab(tab)
  if (tab === 'sessions') loadSessions()
}
function closeDrawer() { document.getElementById('drawer').classList.remove('open') }

function switchDrawerTab(tab) {
  document.querySelectorAll('.drawer-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab))
  document.getElementById('projectsTab').classList.toggle('active', tab === 'projects')
  document.getElementById('sessionsTab').classList.toggle('active', tab === 'sessions')
}

// --- „Çª„ÉÉ„Ç∑„Éß„É≥Â±•Ê≠¥ ---
async function loadSessions() {
  try {
    const res = await fetch('/api/chat/sessions', { credentials: 'include' })
    const sessions = await res.json()
    renderSessionList(sessions)
  } catch (e) {
    console.error('Failed to load sessions:', e)
  }
}

function renderSessionList(list) {
  const container = document.getElementById('sessionList')
  if (list.length === 0) {
    container.innerHTML = '<div style="color:var(--muted);font-size:13px;padding:16px;text-align:center">No sessions yet</div>'
    return
  }
  container.innerHTML = ''
  list.forEach(s => {
    const el = document.createElement('div')
    el.className = 'session-item' + (sessionId === s.sessionId ? ' active' : '')
    el.setAttribute('data-testid', 'session-item')
    const timeStr = new Date(s.lastUsed).toLocaleString('ja-JP', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' })
    el.innerHTML = `
      <span class="preview">${esc(s.messagePreview || s.sessionId)}</span>
      <div class="session-meta">
        <span>${esc(s.model || '')}</span>
        <span>${timeStr}</span>
      </div>
      <button class="delete-session" onclick="event.stopPropagation();deleteSession('${esc(s.id || s.sessionId.slice(0,12))}')">delete</button>
    `
    el.onclick = () => { resumeSession(s); closeDrawer() }
    container.appendChild(el)
  })
}

function resumeSession(s) {
  sessionId = s.sessionId
  messagesEl.innerHTML = ''
  addMessage('user', `(Resumed session: ${s.messagePreview || s.sessionId.slice(0,12)})`)
}

async function deleteSession(id) {
  try {
    await fetch(`/api/chat/sessions/${id}`, { method: 'DELETE', credentials: 'include' })
    loadSessions()
  } catch (e) {
    console.error('Failed to delete session:', e)
  }
}

// --- ‰∏≠Êñ≠ ---
async function abortCurrentStream() {
  if (!currentStreamId) return
  try {
    await fetch('/api/chat/abort', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ streamId: currentStreamId }),
    })
  } catch (e) {
    console.error('Abort failed:', e)
  }
}

function setStreamingUI(streaming) {
  sending = streaming
  sendBtn.disabled = streaming
  sendBtn.style.display = streaming ? 'none' : 'flex'
  abortBtn.style.display = streaming ? 'flex' : 'none'
}

// --- „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø° ---
async function sendMessage() {
  const text = inputEl.value.trim()
  if (!text || sending) return
  setStreamingUI(true)
  inputEl.value = ''
  autoResize()

  addMessage('user', text)
  const assistantEl = addMessage('assistant', '')
  const content = assistantEl.querySelector('.content')
  content.innerHTML = '<div class="typing"><div class="typing-dots"><span></span><span></span><span></span></div></div>'

  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        message: text,
        project: currentProject,
        sessionId,
        model: document.getElementById('model').value,
      }),
    })

    const reader = res.body.getReader()
    const decoder = new TextDecoder()
    let buffer = ''

    while (true) {
      const { done, value } = await reader.read()
      if (done) break
      buffer += decoder.decode(value, { stream: true })

      const blocks = buffer.split('\n\n')
      buffer = blocks.pop() || ''

      for (const block of blocks) {
        if (!block.trim()) continue
        let eventName = 'message'
        const dataLines = []
        for (const line of block.split('\n')) {
          if (line.startsWith('event:')) eventName = line.slice(6).trim()
          else if (line.startsWith('data:')) {
            dataLines.push(line.charAt(5) === ' ' ? line.slice(6) : line.slice(5))
          }
        }
        const data = dataLines.join('\n')
        if (data) handleSSE(eventName, data, content, assistantEl)
      }
    }
  } catch (e) {
    content.innerHTML = `<span style="color:var(--danger)" data-testid="error-message">Error: ${esc(e.message)}</span>`
  }

  currentStreamId = null
  setStreamingUI(false)
  scrollToBottom()
}

function handleSSE(event, data, content, msgEl) {
  if (event === 'text') {
    const typing = content.querySelector('.typing')
    if (typing) typing.remove()

    if (!content._fullText) content._fullText = ''
    content._fullText += data
    const preserved = content.querySelectorAll('.tool-detail, .warning-badge')
    const preservedHTML = Array.from(preserved).map(el => el.outerHTML).join('')
    content.innerHTML = preservedHTML + marked.parse(content._fullText)
    scrollToBottom()
  }

  if (event === 'tool') {
    try {
      const info = JSON.parse(data)
      if (info.status === 'start') {
        // „Çπ„Éà„É™„Éº„Éü„É≥„Ç∞‰∏≠„ÅÆ„Éê„ÉÉ„Ç∏„ÅØ‰∏çË¶ÅÔºàdetail„Éë„Éç„É´„ÅßË°®Á§∫Ôºâ
      }
      if (info.status === 'input' && info.detail) {
        const panel = createToolDetailPanel(info.detail)
        // „ÉÜ„Ç≠„Çπ„ÉàÂá∫Âäõ„ÅÆÂâç„Å´ÊåøÂÖ•
        const firstText = content.querySelector('p, h1, h2, h3, ul, ol, pre, blockquote, table')
        if (firstText) firstText.before(panel)
        else content.prepend(panel)
        scrollToBottom()
      }
      if (info.status === 'output' && info.detail) {
        const panels = content.querySelectorAll('.tool-detail')
        for (let i = panels.length - 1; i >= 0; i--) {
          const nameEl = panels[i].querySelector('.tool-name')
          if (nameEl && nameEl.textContent === info.detail.name) {
            appendToolOutput(panels[i], info.detail.output || '')
            break
          }
        }
        scrollToBottom()
      }
    } catch {}
  }

  if (event === 'warning') {
    try {
      const w = JSON.parse(data)
      const warn = document.createElement('div')
      warn.className = 'warning-badge'
      warn.setAttribute('data-testid', 'warning-badge')
      warn.innerHTML = `&#9888; <strong>${esc(w.label)}</strong> ${esc(w.command)}`
      content.appendChild(warn)
      scrollToBottom()
    } catch {}
  }

  if (event === 'session') {
    try {
      const s = JSON.parse(data)
      if (s.sessionId) sessionId = s.sessionId
      if (s.streamId) currentStreamId = s.streamId
    } catch {}
  }

  if (event === 'result') {
    try {
      const r = JSON.parse(data)
      if (r.sessionId) sessionId = r.sessionId
      if (r.text && !content._fullText) {
        content.innerHTML = marked.parse(r.text)
      }
      if (r.cost || r.durationMs) {
        const meta = document.createElement('div')
        meta.className = 'meta'
        meta.setAttribute('data-testid', 'result-meta')
        if (r.cost) meta.innerHTML += `<span>$${r.cost.toFixed(4)}</span>`
        if (r.durationMs) meta.innerHTML += `<span>${(r.durationMs / 1000).toFixed(1)}s</span>`
        if (r.turns) meta.innerHTML += `<span>${r.turns} turns</span>`
        msgEl.appendChild(meta)
      }
    } catch {}
  }

  if (event === 'error') {
    try {
      const e = JSON.parse(data)
      content.innerHTML = `<span style="color:var(--danger)" data-testid="error-message">Error: ${esc(e.message)}</span>`
    } catch {}
  }
}

// --- „ÉÑ„Éº„É´Ë©≥Á¥∞„Éë„Éç„É´ ---
function createToolDetailPanel(detail) {
  const panel = document.createElement('div')
  panel.className = 'tool-detail'
  panel.setAttribute('data-testid', 'tool-detail')

  const summary = getToolSummary(detail)
  const icon = TOOL_ICONS[detail.name] || 'üîß'

  panel.innerHTML = `
    <div class="tool-detail-header" onclick="toggleToolDetail(this)">
      <span class="tool-chevron">&#9654;</span>
      <div class="tool-icon-label">
        <span class="tool-emoji">${icon}</span>
        <span class="tool-name">${esc(detail.name)}</span>
      </div>
      <span class="tool-file">${esc(summary)}</span>
      <span class="tool-status">&#10003;</span>
    </div>
    <div class="tool-detail-body">${formatToolInput(detail)}</div>
  `
  return panel
}

function getToolSummary(detail) {
  if (!detail.input) return ''
  const inp = detail.input
  if (detail.name === 'Read') return inp.file_path || ''
  if (detail.name === 'Write') return inp.file_path || ''
  if (detail.name === 'Edit') return inp.file_path || ''
  if (detail.name === 'Bash') return (inp.command || '').slice(0, 80)
  if (detail.name === 'Glob') return inp.pattern || ''
  if (detail.name === 'Grep') return inp.pattern || ''
  return JSON.stringify(inp).slice(0, 80)
}

function formatToolInput(detail) {
  if (!detail.input) return ''
  const inp = detail.input

  if (detail.name === 'Edit' && inp.old_string !== undefined && inp.new_string !== undefined) {
    return formatDiff(inp.old_string || '', inp.new_string || '', inp.file_path || '')
  }
  if (detail.name === 'Bash') {
    return `<div style="color:var(--accent)">$ ${esc(inp.command || '')}</div>`
  }
  if (detail.name === 'Write') {
    const content = inp.content || ''
    return `<div class="diff-add" style="max-height:200px;overflow:auto;padding:4px 6px">${esc(content)}</div>`
  }
  return `<div>${esc(JSON.stringify(inp, null, 2))}</div>`
}

function formatDiff(oldStr, newStr, filePath) {
  const oldLines = oldStr.split('\n')
  const newLines = newStr.split('\n')
  let html = ''
  if (filePath) html += `<div class="diff-hunk">--- ${esc(filePath)}</div>`
  oldLines.forEach(l => { html += `<div class="diff-line diff-del">- ${esc(l)}</div>` })
  newLines.forEach(l => { html += `<div class="diff-line diff-add">+ ${esc(l)}</div>` })
  return html
}

function appendToolOutput(panel, output) {
  const body = panel.querySelector('.tool-detail-body')
  if (!body) return
  if (output) {
    body.innerHTML += `<div style="margin-top:6px;border-top:1px solid var(--border);padding-top:6px;color:var(--muted)">${esc(output)}</div>`
  }
}

function toggleToolDetail(header) {
  const icon = header.querySelector('.tool-chevron')
  const body = header.nextElementSibling
  icon.classList.toggle('open')
  body.classList.toggle('open')
}

// --- UI helpers ---
function addMessage(role, text) {
  const el = document.createElement('div')
  el.className = `msg ${role}`
  el.setAttribute('data-testid', `msg-${role}`)
  if (role === 'user') {
    el.innerHTML = `<div class="bubble">${esc(text)}</div>`
  } else {
    el.innerHTML = `<div class="content">${text}</div>`
  }
  messagesEl.appendChild(el)
  scrollToBottom()
  return el
}

function scrollToBottom() {
  requestAnimationFrame(() => messagesEl.scrollTop = messagesEl.scrollHeight)
}

function esc(s) {
  if (typeof s !== 'string') s = String(s || '')
  const d = document.createElement('div')
  d.textContent = s
  return d.innerHTML
}

function autoResize() {
  inputEl.style.height = 'auto'
  inputEl.style.height = Math.min(inputEl.scrollHeight, 150) + 'px'
}
inputEl.addEventListener('input', autoResize)

inputEl.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey && !e.isComposing) {
    e.preventDefault()
    sendMessage()
  }
})

init()
</script>
</body>
</html>
