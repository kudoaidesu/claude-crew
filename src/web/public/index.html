<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Claude Code</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@0.469.0/font/lucide.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#1e1e2e;--surface:#252536;--surface-hover:#2a2a3d;
  --border:#333346;--border-light:#3e3e56;
  --text:#cdd6f4;--text-bright:#fff;--muted:#6c7086;
  --accent:#c084fc;--accent-dim:rgba(192,132,252,.12);--accent-border:rgba(192,132,252,.25);
  --user-bg:#2a2a3d;--user-border:#3e3e56;
  --warning:#f9e2af;--warning-bg:rgba(249,226,175,.08);
  --danger:#f38ba8;--danger-bg:rgba(243,139,168,.08);
  --success:#a6e3a1;--success-bg:rgba(166,227,161,.08);
  --diff-add:rgba(166,227,161,.12);--diff-del:rgba(243,139,168,.12);
  --diff-add-text:#a6e3a1;--diff-del-text:#f38ba8;
  --font-sans:-apple-system,system-ui,'Segoe UI','Helvetica Neue',sans-serif;
  --font-mono:'SF Mono',Menlo,'Cascadia Code','JetBrains Mono',Consolas,monospace;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--font-sans);font-size:14px;line-height:1.6}
body{display:flex;flex-direction:column;height:100dvh}

/* ── ヘッダー ── */
.header{display:flex;align-items:center;gap:8px;padding:10px 16px;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0}
.header-logo{display:flex;align-items:center;gap:6px;color:var(--accent);font-weight:700;font-size:13px;font-family:var(--font-mono)}
.header-logo i{font-size:18px}
.header-spacer{flex:1}
.header-btn{background:none;border:1px solid var(--border);color:var(--muted);border-radius:6px;padding:4px 10px;font-size:12px;font-family:var(--font-mono);cursor:pointer;display:flex;align-items:center;gap:4px;transition:all .15s}
.header-btn:hover{color:var(--text);border-color:var(--border-light);background:var(--surface-hover)}
.header-btn.active{color:var(--accent);border-color:var(--accent-border)}
.header-btn i{font-size:14px}
.model-select{background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-size:12px;font-family:var(--font-mono);cursor:pointer}
.model-select:focus{outline:none;border-color:var(--accent)}

/* ── セッションタブバー ── */
.tab-bar{display:flex;align-items:center;gap:0;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.tab-bar::-webkit-scrollbar{display:none}
.tab{display:flex;align-items:center;gap:6px;padding:6px 12px;font-size:12px;font-family:var(--font-mono);color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;transition:all .1s;min-width:0;max-width:180px;flex-shrink:0;position:relative}
.tab:hover{color:var(--text);background:var(--surface-hover)}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.tab .tab-label{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tab .tab-streaming{width:6px;height:6px;border-radius:50%;background:var(--accent);animation:pulse 1.2s infinite;flex-shrink:0}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.tab .tab-close{font-size:12px;color:var(--muted);cursor:pointer;padding:0 2px;border-radius:3px;transition:all .1s;flex-shrink:0;display:flex;align-items:center}
.tab .tab-close:hover{color:var(--danger);background:var(--danger-bg)}
.tab-add{display:flex;align-items:center;justify-content:center;padding:6px 10px;color:var(--muted);cursor:pointer;transition:all .1s;flex-shrink:0}
.tab-add:hover{color:var(--accent);background:var(--surface-hover)}
.tab-add i{font-size:14px}

/* ── メッセージエリア ── */
.messages{flex:1;overflow-y:auto;padding:16px;-webkit-overflow-scrolling:touch;display:flex;flex-direction:column;gap:16px;display:none}
.messages.active{display:flex}

/* ── ユーザーメッセージ ── */
.msg.user{display:flex;justify-content:flex-end}
.msg.user .bubble{background:var(--user-bg);border:1px solid var(--user-border);border-radius:12px 12px 2px 12px;padding:10px 14px;max-width:85%;white-space:pre-wrap;word-break:break-word;font-size:14px;line-height:1.5;color:var(--text-bright)}

/* ── アシスタントメッセージ ── */
.msg.assistant{display:flex;flex-direction:column;gap:8px}
.msg.assistant .content{color:var(--text);word-break:break-word;font-size:14px;line-height:1.7}

/* ── マークダウン ── */
.msg.assistant .content h1{font-size:20px;font-weight:700;margin:16px 0 8px;color:var(--text-bright)}
.msg.assistant .content h2{font-size:17px;font-weight:700;margin:14px 0 6px;color:var(--text-bright)}
.msg.assistant .content h3{font-size:15px;font-weight:700;margin:12px 0 4px;color:var(--text-bright)}
.msg.assistant .content p{margin:6px 0}
.msg.assistant .content ul,.msg.assistant .content ol{padding-left:20px;margin:6px 0}
.msg.assistant .content li{margin:2px 0}
.msg.assistant .content li::marker{color:var(--muted)}
.msg.assistant .content strong{color:var(--text-bright);font-weight:600}
.msg.assistant .content em{color:var(--muted);font-style:italic}
.msg.assistant .content hr{border:none;border-top:1px solid var(--border);margin:12px 0}
.msg.assistant .content a{color:var(--accent);text-decoration:none}
.msg.assistant .content a:hover{text-decoration:underline}

/* ── コードブロック ── */
.msg.assistant .content pre{position:relative;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px 14px;overflow-x:auto;margin:8px 0;font-size:13px;line-height:1.5}
.msg.assistant .content code{font-family:var(--font-mono);font-size:13px}
.msg.assistant .content p code,
.msg.assistant .content li code{background:rgba(192,132,252,.12);color:var(--accent);padding:2px 6px;border-radius:4px;font-size:12px}
.msg.assistant .content pre code{background:none;padding:0;border-radius:0;font-size:13px;color:var(--text)}
.code-copy-btn{position:absolute;top:8px;right:8px;background:var(--surface);color:var(--muted);border:1px solid var(--border);border-radius:4px;padding:2px 8px;font-size:11px;font-family:var(--font-mono);cursor:pointer;opacity:0;transition:opacity .15s}
pre:hover .code-copy-btn{opacity:1}
.code-copy-btn:hover{color:var(--accent);border-color:var(--accent-border)}
.code-copy-btn.copied{color:var(--success);border-color:var(--success)}

/* ── テーブル ── */
.msg.assistant .content table{border-collapse:collapse;width:100%;margin:8px 0;font-size:13px;font-family:var(--font-mono)}
.msg.assistant .content th{background:var(--surface);color:var(--text-bright);font-weight:600;text-align:left;padding:6px 10px;border:1px solid var(--border)}
.msg.assistant .content td{padding:6px 10px;border:1px solid var(--border)}
.msg.assistant .content tr:nth-child(even) td{background:var(--surface)}

/* ── 引用 ── */
.msg.assistant .content blockquote{border-left:3px solid var(--accent);padding:4px 12px;margin:8px 0;color:var(--muted);background:var(--accent-dim);border-radius:0 6px 6px 0}

/* ── ツール実行パネル ── */
.tool-detail{margin:4px 0;border:1px solid var(--border);border-radius:8px;overflow:hidden;font-family:var(--font-mono);font-size:12px;background:var(--surface)}
.tool-detail-header{display:flex;align-items:center;gap:8px;padding:8px 12px;cursor:pointer;user-select:none;transition:background .1s}
.tool-detail-header:hover{background:var(--surface-hover)}
.tool-detail-header .tool-chevron{font-size:9px;color:var(--muted);transition:transform .15s;width:12px;text-align:center}
.tool-detail-header .tool-chevron.open{transform:rotate(90deg)}
.tool-detail-header .tool-icon-label{display:flex;align-items:center;gap:6px}
.tool-detail-header .tool-icon{font-size:13px;color:var(--muted);width:16px;text-align:center}
.tool-detail-header .tool-name{color:var(--accent);font-weight:600;font-size:12px}
.tool-detail-header .tool-file{color:var(--muted);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:11px}
.tool-detail-header .tool-status{font-size:10px;color:var(--success)}
.tool-detail-body{display:none;padding:10px 12px;background:var(--bg);border-top:1px solid var(--border);max-height:300px;overflow:auto;white-space:pre-wrap;word-break:break-all;color:var(--text);line-height:1.4;font-size:12px}
.tool-detail-body.open{display:block}

/* diff */
.diff-line{padding:1px 6px;font-family:var(--font-mono);font-size:12px}
.diff-add{background:var(--diff-add);color:var(--diff-add-text)}
.diff-del{background:var(--diff-del);color:var(--diff-del-text)}
.diff-hunk{color:var(--accent);font-weight:600;margin-top:4px;font-size:11px}

/* ── 警告バッジ ── */
.warning-badge{display:flex;align-items:center;gap:8px;background:var(--warning-bg);color:var(--warning);border:1px solid rgba(249,226,175,.2);border-radius:8px;padding:8px 12px;font-size:12px;margin:4px 0;font-family:var(--font-mono)}
.warning-badge i{font-size:14px}

/* ── コスト表示 ── */
.meta{font-size:11px;color:var(--muted);margin-top:2px;display:flex;gap:12px;font-family:var(--font-mono)}

/* ── 入力エリア ── */
.input-area{border-top:1px solid var(--border);background:var(--surface);padding:12px 16px;padding-bottom:calc(12px + env(safe-area-inset-bottom));flex-shrink:0}
.input-box{border:1px solid var(--border);border-radius:10px;background:var(--bg);overflow:hidden;transition:border-color .15s}
.input-box:focus-within{border-color:var(--accent-border)}
.input-box textarea{width:100%;background:transparent;color:var(--text);border:none;padding:10px 14px;font-size:14px;font-family:var(--font-sans);resize:none;min-height:40px;max-height:150px;line-height:1.4}
.input-box textarea:focus{outline:none}
.input-box textarea::placeholder{color:var(--muted)}
.input-footer{display:flex;align-items:center;gap:6px;padding:4px 8px 6px}
.input-footer .model-indicator{font-size:11px;color:var(--muted);font-family:var(--font-mono);flex:1}
.input-footer button{width:30px;height:30px;border:none;border-radius:6px;background:transparent;color:var(--muted);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .1s}
.input-footer button:hover{background:var(--accent-dim);color:var(--accent)}
.input-footer button:disabled{opacity:.3;cursor:not-allowed}
.input-footer button.send-btn{background:var(--accent);color:#1e1e2e;border-radius:6px}
.input-footer button.send-btn:hover{opacity:.9}
.input-footer button.send-btn:disabled{opacity:.3}
.input-footer button.abort-btn{display:none;background:var(--danger-bg);color:var(--danger)}
.input-footer button.abort-btn:hover{background:rgba(243,139,168,.2)}

/* ── ローディング ── */
.typing{display:flex;align-items:center;gap:6px;padding:8px 0;color:var(--muted);font-size:13px}
.typing-dots{display:flex;gap:3px}
.typing-dots span{width:5px;height:5px;background:var(--accent);border-radius:50%;animation:bounce .6s infinite alternate;opacity:.5}
.typing-dots span:nth-child(2){animation-delay:.2s}
.typing-dots span:nth-child(3){animation-delay:.4s}
@keyframes bounce{to{opacity:.15;transform:translateY(-3px)}}

/* ── ドロワー ── */
.drawer{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:10;display:none;backdrop-filter:blur(2px)}
.drawer.open{display:block}
.drawer-content{position:absolute;bottom:0;left:0;right:0;background:var(--surface);border-radius:14px 14px 0 0;padding:16px;padding-bottom:calc(16px + env(safe-area-inset-bottom));max-height:70vh;overflow-y:auto;border:1px solid var(--border)}

/* ドロワータブ */
.drawer-tabs{display:flex;gap:0;margin-bottom:12px;border-bottom:1px solid var(--border)}
.drawer-tab{padding:8px 14px;font-size:13px;color:var(--muted);cursor:pointer;border:none;background:none;font-family:var(--font-sans);border-bottom:2px solid transparent;font-weight:500;transition:color .1s}
.drawer-tab:hover{color:var(--text)}
.drawer-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.drawer-tab-content{display:none}
.drawer-tab-content.active{display:block}

/* プロジェクトアイテム */
.project-item{display:flex;flex-direction:column;padding:10px 12px;border:1px solid var(--border);border-radius:8px;margin-bottom:6px;cursor:pointer;transition:all .1s}
.project-item:hover{border-color:var(--border-light);background:var(--surface-hover)}
.project-item.active{border-color:var(--accent-border);background:var(--accent-dim)}
.project-item .name{font-weight:600;font-size:13px;color:var(--text-bright)}
.project-item .path{font-size:11px;color:var(--muted);margin-top:2px;font-family:var(--font-mono)}

/* セッションアイテム */
.session-item{display:flex;flex-direction:column;padding:10px 12px;border:1px solid var(--border);border-radius:8px;margin-bottom:6px;cursor:pointer;transition:all .1s}
.session-item:hover{border-color:var(--border-light);background:var(--surface-hover)}
.session-item.active{border-color:var(--accent-border);background:var(--accent-dim)}
.session-item .preview{font-size:13px;color:var(--text-bright);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.session-item .session-meta{display:flex;gap:8px;font-size:11px;color:var(--muted);margin-top:4px;font-family:var(--font-mono)}
.session-item .delete-session{align-self:flex-end;color:var(--danger);background:none;border:none;font-size:11px;cursor:pointer;padding:2px 6px;font-family:var(--font-mono);opacity:.6;transition:opacity .1s;display:flex;align-items:center;gap:3px}
.session-item .delete-session:hover{opacity:1}
</style>
</head>
<body>

<div class="header">
  <div class="header-logo">
    <i class="icon-terminal"></i>
    <span id="title">claude-crew</span>
  </div>
  <div class="header-spacer"></div>
  <select id="model" class="model-select">
    <option value="default">default (auto)</option>
    <option value="claude-sonnet-4-6" selected>claude-sonnet-4-6</option>
    <option value="claude-opus-4-6">claude-opus-4-6</option>
    <option value="claude-haiku-4-5">claude-haiku-4-5</option>
    <option value="sonnet">sonnet (alias)</option>
    <option value="opus">opus (alias)</option>
    <option value="haiku">haiku (alias)</option>
  </select>
  <button class="header-btn" id="historyBtn" onclick="openDrawer('sessions')" title="History"><i class="icon-clock"></i> History</button>
  <button class="header-btn" onclick="openDrawer('projects')" title="Projects"><i class="icon-folder"></i></button>
</div>

<div class="tab-bar" id="tabBar">
  <div class="tab-add" onclick="createNewTab()" title="New Chat"><i class="icon-plus"></i></div>
</div>

<div id="sessionsContainer"></div>

<div class="input-area">
  <div class="input-box">
    <textarea id="input" rows="1" placeholder="Ask Claude anything..." enterkeyhint="send"></textarea>
    <div class="input-footer">
      <span class="model-indicator" id="modelIndicator">claude-sonnet-4-6</span>
      <button class="abort-btn" id="abort" onclick="abortCurrentTab()" title="Stop"><i class="icon-square"></i></button>
      <button class="send-btn" id="send" onclick="sendMessage()" title="Send (Enter)"><i class="icon-send"></i></button>
    </div>
  </div>
</div>

<div class="drawer" id="drawer" onclick="closeDrawer()">
  <div class="drawer-content" onclick="event.stopPropagation()">
    <div class="drawer-tabs">
      <button class="drawer-tab active" data-tab="projects" onclick="switchDrawerTab('projects')">Projects</button>
      <button class="drawer-tab" data-tab="sessions" onclick="switchDrawerTab('sessions')">Sessions</button>
    </div>
    <div id="projectsTab" class="drawer-tab-content active">
      <div id="projectList"></div>
    </div>
    <div id="sessionsTab" class="drawer-tab-content">
      <div id="sessionList"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked@15/marked.min.js"></script>
<script>
// --- ツールアイコンマップ (Lucide) ---
const TOOL_ICONS = {
  Read: 'icon-file-text', Write: 'icon-file-pen', Edit: 'icon-file-pen', Bash: 'icon-terminal',
  Glob: 'icon-search', Grep: 'icon-search', WebFetch: 'icon-globe', WebSearch: 'icon-globe',
  Task: 'icon-bot', TodoWrite: 'icon-list-checks', NotebookEdit: 'icon-notebook-pen',
}

// --- State ---
let currentProject = null
const sendBtn = document.getElementById('send')
const abortBtn = document.getElementById('abort')
const modelIndicator = document.getElementById('modelIndicator')
const inputEl = document.getElementById('input')
const tabBar = document.getElementById('tabBar')
const sessionsContainer = document.getElementById('sessionsContainer')

// マルチセッション管理
let activeTabId = null
const tabs = new Map() // tabId → { sessionId, streamId, sending, messagesEl, fullTexts, label }

function genTabId() { return 'tab-' + Date.now() + '-' + Math.random().toString(36).slice(2,6) }

// --- marked カスタムレンダラー ---
const renderer = new marked.Renderer()
renderer.code = function({ text, lang }) {
  const langLabel = lang ? esc(lang) : ''
  const escaped = esc(text)
  return `<pre><button class="code-copy-btn" onclick="copyCode(this)" data-testid="code-copy-btn">Copy</button><code class="language-${langLabel}">${escaped}</code></pre>`
}
marked.setOptions({ renderer, breaks: true })

// --- コードコピー ---
function copyCode(btn) {
  const code = btn.parentElement.querySelector('code')
  const text = code.textContent
  navigator.clipboard.writeText(text).then(() => {
    btn.textContent = 'Copied!'
    btn.classList.add('copied')
    setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied') }, 1500)
  }).catch(() => {
    const ta = document.createElement('textarea')
    ta.value = text
    document.body.appendChild(ta)
    ta.select()
    document.execCommand('copy')
    document.body.removeChild(ta)
    btn.textContent = 'Copied!'
    btn.classList.add('copied')
    setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied') }, 1500)
  })
}

// --- モデル選択 ---
document.getElementById('model').addEventListener('change', (e) => {
  modelIndicator.textContent = e.target.value
})

// --- タブ管理 ---
function createNewTab(label) {
  const tabId = genTabId()
  const messagesEl = document.createElement('div')
  messagesEl.className = 'messages'
  messagesEl.id = 'msgs-' + tabId
  sessionsContainer.appendChild(messagesEl)

  tabs.set(tabId, {
    sessionId: null,
    streamId: null,
    sending: false,
    messagesEl,
    fullTexts: new WeakMap(),
    label: label || 'New Chat',
  })

  renderTabs()
  switchTab(tabId)
  return tabId
}

function switchTab(tabId) {
  if (!tabs.has(tabId)) return
  activeTabId = tabId
  // メッセージ表示切替
  tabs.forEach((t, id) => {
    t.messagesEl.classList.toggle('active', id === tabId)
  })
  // タブUI更新
  renderTabs()
  // 送信状態を反映
  const tab = tabs.get(tabId)
  updateStreamingUI(tab.sending)
  inputEl.focus()
}

function closeTab(tabId) {
  const tab = tabs.get(tabId)
  if (!tab) return
  // ストリーミング中なら中断
  if (tab.sending && tab.streamId) {
    fetch('/api/chat/abort', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ streamId: tab.streamId }),
    }).catch(() => {})
  }
  tab.messagesEl.remove()
  tabs.delete(tabId)
  // 別タブに切り替え
  if (activeTabId === tabId) {
    const remaining = Array.from(tabs.keys())
    if (remaining.length > 0) {
      switchTab(remaining[remaining.length - 1])
    } else {
      createNewTab()
    }
  } else {
    renderTabs()
  }
}

function renderTabs() {
  // タブ要素を再構築（+ボタンの前に挿入）
  const addBtn = tabBar.querySelector('.tab-add')
  tabBar.querySelectorAll('.tab').forEach(t => t.remove())

  tabs.forEach((tab, tabId) => {
    const el = document.createElement('div')
    el.className = 'tab' + (tabId === activeTabId ? ' active' : '')
    el.onclick = (e) => { if (!e.target.closest('.tab-close')) switchTab(tabId) }

    let inner = ''
    if (tab.sending) inner += '<span class="tab-streaming"></span>'
    inner += `<span class="tab-label">${esc(tab.label)}</span>`
    if (tabs.size > 1) inner += `<span class="tab-close" onclick="closeTab('${tabId}')"><i class="icon-x" style="font-size:11px"></i></span>`
    el.innerHTML = inner
    tabBar.insertBefore(el, addBtn)
  })
}

function updateTabLabel(tabId, label) {
  const tab = tabs.get(tabId)
  if (tab) {
    tab.label = label.slice(0, 30) || 'New Chat'
    renderTabs()
  }
}

// --- ストリーミングUI ---
function updateStreamingUI(streaming) {
  sendBtn.disabled = streaming
  sendBtn.style.display = streaming ? 'none' : 'flex'
  abortBtn.style.display = streaming ? 'flex' : 'none'
}

function abortCurrentTab() {
  const tab = tabs.get(activeTabId)
  if (!tab || !tab.streamId) return
  fetch('/api/chat/abort', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({ streamId: tab.streamId }),
  }).catch(e => console.error('Abort failed:', e))
}

// --- 初期化 ---
async function init() {
  try {
    const res = await fetch('/api/projects', { credentials: 'include' })
    const projects = await res.json()
    renderProjectList(projects)
    if (!currentProject && projects.length > 0) selectProject(projects[0])
  } catch (e) {
    console.error('Failed to load projects:', e)
  }
  // 最初のタブ
  createNewTab()
}

function renderProjectList(projects) {
  const list = document.getElementById('projectList')
  list.innerHTML = ''
  projects.forEach(p => {
    const el = document.createElement('div')
    el.className = 'project-item' + (currentProject === p.localPath ? ' active' : '')
    el.innerHTML = `<span class="name">${esc(p.slug)}</span><span class="path">${esc(p.localPath)}</span>`
    el.onclick = () => { selectProject(p); closeDrawer() }
    list.appendChild(el)
  })
}

function selectProject(p) {
  currentProject = p.localPath
  document.getElementById('title').textContent = p.slug
}

// --- ドロワー ---
function openDrawer(tab) {
  document.getElementById('drawer').classList.add('open')
  if (tab) switchDrawerTab(tab)
  if (tab === 'sessions') loadSessions()
}
function closeDrawer() { document.getElementById('drawer').classList.remove('open') }

function switchDrawerTab(tab) {
  document.querySelectorAll('.drawer-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab))
  document.getElementById('projectsTab').classList.toggle('active', tab === 'projects')
  document.getElementById('sessionsTab').classList.toggle('active', tab === 'sessions')
}

// --- セッション履歴 ---
async function loadSessions() {
  try {
    const res = await fetch('/api/chat/sessions', { credentials: 'include' })
    const sessions = await res.json()
    renderSessionList(sessions)
  } catch (e) {
    console.error('Failed to load sessions:', e)
  }
}

function renderSessionList(list) {
  const container = document.getElementById('sessionList')
  if (list.length === 0) {
    container.innerHTML = '<div style="color:var(--muted);font-size:13px;padding:16px;text-align:center">No sessions yet</div>'
    return
  }
  container.innerHTML = ''
  list.forEach(s => {
    const el = document.createElement('div')
    // activeなタブのsessionIdと一致するか判定
    let isActive = false
    tabs.forEach(t => { if (t.sessionId === s.sessionId) isActive = true })
    el.className = 'session-item' + (isActive ? ' active' : '')
    el.setAttribute('data-testid', 'session-item')
    const timeStr = new Date(s.lastUsed).toLocaleString('ja-JP', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' })
    el.innerHTML = `
      <span class="preview">${esc(s.messagePreview || s.sessionId)}</span>
      <div class="session-meta">
        <span>${esc(s.model || '')}</span>
        <span>${timeStr}</span>
      </div>
      <button class="delete-session" onclick="event.stopPropagation();deleteSession('${esc(s.id || s.sessionId.slice(0,12))}')"><i class="icon-trash-2" style="font-size:11px"></i> delete</button>
    `
    el.onclick = () => { resumeSession(s); closeDrawer() }
    container.appendChild(el)
  })
}

function resumeSession(s) {
  const tabId = createNewTab(s.messagePreview || s.sessionId.slice(0, 12))
  const tab = tabs.get(tabId)
  tab.sessionId = s.sessionId
  addMessage(tabId, 'user', `(Resumed: ${s.messagePreview || s.sessionId.slice(0,12)})`)
}

async function deleteSession(id) {
  try {
    await fetch(`/api/chat/sessions/${id}`, { method: 'DELETE', credentials: 'include' })
    loadSessions()
  } catch (e) {
    console.error('Failed to delete session:', e)
  }
}

// --- メッセージ送信 ---
async function sendMessage() {
  const text = inputEl.value.trim()
  if (!text) return
  if (!activeTabId || !tabs.has(activeTabId)) return

  const tab = tabs.get(activeTabId)
  if (tab.sending) return

  tab.sending = true
  updateStreamingUI(true)
  renderTabs()
  inputEl.value = ''
  autoResize()

  // タブラベル更新（最初のメッセージ）
  if (tab.label === 'New Chat') {
    updateTabLabel(activeTabId, text)
  }

  const tabId = activeTabId
  addMessage(tabId, 'user', text)
  const assistantEl = addMessage(tabId, 'assistant', '')
  const content = assistantEl.querySelector('.content')
  content.innerHTML = '<div class="typing"><div class="typing-dots"><span></span><span></span><span></span></div></div>'

  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        message: text,
        project: currentProject,
        sessionId: tab.sessionId,
        model: document.getElementById('model').value,
      }),
    })

    const reader = res.body.getReader()
    const decoder = new TextDecoder()
    let buffer = ''

    while (true) {
      const { done, value } = await reader.read()
      if (done) break
      buffer += decoder.decode(value, { stream: true })

      const blocks = buffer.split('\n\n')
      buffer = blocks.pop() || ''

      for (const block of blocks) {
        if (!block.trim()) continue
        let eventName = 'message'
        const dataLines = []
        for (const line of block.split('\n')) {
          if (line.startsWith('event:')) eventName = line.slice(6).trim()
          else if (line.startsWith('data:')) {
            dataLines.push(line.charAt(5) === ' ' ? line.slice(6) : line.slice(5))
          }
        }
        const data = dataLines.join('\n')
        if (data) handleSSE(tabId, eventName, data, content, assistantEl)
      }
    }
  } catch (e) {
    content.innerHTML = `<span style="color:var(--danger)" data-testid="error-message">Error: ${esc(e.message)}</span>`
  }

  tab.sending = false
  tab.streamId = null
  if (activeTabId === tabId) updateStreamingUI(false)
  renderTabs()
  scrollToBottom(tabId)
}

function handleSSE(tabId, event, data, content, msgEl) {
  const tab = tabs.get(tabId)
  if (!tab) return

  if (event === 'text') {
    const typing = content.querySelector('.typing')
    if (typing) typing.remove()

    if (!tab.fullTexts.has(content)) tab.fullTexts.set(content, '')
    tab.fullTexts.set(content, tab.fullTexts.get(content) + data)
    const preserved = content.querySelectorAll('.tool-detail, .warning-badge')
    const preservedHTML = Array.from(preserved).map(el => el.outerHTML).join('')
    content.innerHTML = preservedHTML + marked.parse(tab.fullTexts.get(content))
    scrollToBottom(tabId)
  }

  if (event === 'tool') {
    try {
      const info = JSON.parse(data)
      if (info.status === 'start') {
        // detailパネルで表示するため不要
      }
      if (info.status === 'input' && info.detail) {
        const panel = createToolDetailPanel(info.detail)
        const firstText = content.querySelector('p, h1, h2, h3, ul, ol, pre, blockquote, table')
        if (firstText) firstText.before(panel)
        else content.prepend(panel)
        scrollToBottom(tabId)
      }
      if (info.status === 'output' && info.detail) {
        const panels = content.querySelectorAll('.tool-detail')
        for (let i = panels.length - 1; i >= 0; i--) {
          const nameEl = panels[i].querySelector('.tool-name')
          if (nameEl && nameEl.textContent === info.detail.name) {
            appendToolOutput(panels[i], info.detail.output || '')
            break
          }
        }
        scrollToBottom(tabId)
      }
    } catch {}
  }

  if (event === 'warning') {
    try {
      const w = JSON.parse(data)
      const warn = document.createElement('div')
      warn.className = 'warning-badge'
      warn.setAttribute('data-testid', 'warning-badge')
      warn.innerHTML = `<i class="icon-alert-triangle"></i> <strong>${esc(w.label)}</strong> ${esc(w.command)}`
      content.appendChild(warn)
      scrollToBottom(tabId)
    } catch {}
  }

  if (event === 'session') {
    try {
      const s = JSON.parse(data)
      if (s.sessionId) tab.sessionId = s.sessionId
      if (s.streamId) tab.streamId = s.streamId
    } catch {}
  }

  if (event === 'result') {
    try {
      const r = JSON.parse(data)
      if (r.sessionId) tab.sessionId = r.sessionId
      if (r.text && !tab.fullTexts.has(content)) {
        content.innerHTML = marked.parse(r.text)
      }
      if (r.cost || r.durationMs) {
        const meta = document.createElement('div')
        meta.className = 'meta'
        meta.setAttribute('data-testid', 'result-meta')
        if (r.cost) meta.innerHTML += `<span>$${r.cost.toFixed(4)}</span>`
        if (r.durationMs) meta.innerHTML += `<span>${(r.durationMs / 1000).toFixed(1)}s</span>`
        if (r.turns) meta.innerHTML += `<span>${r.turns} turns</span>`
        msgEl.appendChild(meta)
      }
    } catch {}
  }

  if (event === 'error') {
    try {
      const e = JSON.parse(data)
      content.innerHTML = `<span style="color:var(--danger)" data-testid="error-message">Error: ${esc(e.message)}</span>`
    } catch {}
  }
}

// --- ツール詳細パネル ---
function createToolDetailPanel(detail) {
  const panel = document.createElement('div')
  panel.className = 'tool-detail'
  panel.setAttribute('data-testid', 'tool-detail')

  const summary = getToolSummary(detail)
  const iconClass = TOOL_ICONS[detail.name] || 'icon-wrench'

  panel.innerHTML = `
    <div class="tool-detail-header" onclick="toggleToolDetail(this)">
      <span class="tool-chevron"><i class="icon-chevron-right" style="font-size:9px"></i></span>
      <div class="tool-icon-label">
        <i class="${iconClass} tool-icon"></i>
        <span class="tool-name">${esc(detail.name)}</span>
      </div>
      <span class="tool-file">${esc(summary)}</span>
      <span class="tool-status"><i class="icon-check" style="font-size:12px"></i></span>
    </div>
    <div class="tool-detail-body">${formatToolInput(detail)}</div>
  `
  return panel
}

function getToolSummary(detail) {
  if (!detail.input) return ''
  const inp = detail.input
  if (detail.name === 'Read') return inp.file_path || ''
  if (detail.name === 'Write') return inp.file_path || ''
  if (detail.name === 'Edit') return inp.file_path || ''
  if (detail.name === 'Bash') return (inp.command || '').slice(0, 80)
  if (detail.name === 'Glob') return inp.pattern || ''
  if (detail.name === 'Grep') return inp.pattern || ''
  return JSON.stringify(inp).slice(0, 80)
}

function formatToolInput(detail) {
  if (!detail.input) return ''
  const inp = detail.input

  if (detail.name === 'Edit' && inp.old_string !== undefined && inp.new_string !== undefined) {
    return formatDiff(inp.old_string || '', inp.new_string || '', inp.file_path || '')
  }
  if (detail.name === 'Bash') {
    return `<div style="color:var(--accent)">$ ${esc(inp.command || '')}</div>`
  }
  if (detail.name === 'Write') {
    const content = inp.content || ''
    return `<div class="diff-add" style="max-height:200px;overflow:auto;padding:4px 6px">${esc(content)}</div>`
  }
  return `<div>${esc(JSON.stringify(inp, null, 2))}</div>`
}

function formatDiff(oldStr, newStr, filePath) {
  const oldLines = oldStr.split('\n')
  const newLines = newStr.split('\n')
  let html = ''
  if (filePath) html += `<div class="diff-hunk">--- ${esc(filePath)}</div>`
  oldLines.forEach(l => { html += `<div class="diff-line diff-del">- ${esc(l)}</div>` })
  newLines.forEach(l => { html += `<div class="diff-line diff-add">+ ${esc(l)}</div>` })
  return html
}

function appendToolOutput(panel, output) {
  const body = panel.querySelector('.tool-detail-body')
  if (!body) return
  if (output) {
    body.innerHTML += `<div style="margin-top:6px;border-top:1px solid var(--border);padding-top:6px;color:var(--muted)">${esc(output)}</div>`
  }
}

function toggleToolDetail(header) {
  const icon = header.querySelector('.tool-chevron')
  const body = header.nextElementSibling
  icon.classList.toggle('open')
  body.classList.toggle('open')
}

// --- UI helpers ---
function addMessage(tabId, role, text) {
  const tab = tabs.get(tabId)
  if (!tab) return
  const el = document.createElement('div')
  el.className = `msg ${role}`
  el.setAttribute('data-testid', `msg-${role}`)
  if (role === 'user') {
    el.innerHTML = `<div class="bubble">${esc(text)}</div>`
  } else {
    el.innerHTML = `<div class="content">${text}</div>`
  }
  tab.messagesEl.appendChild(el)
  scrollToBottom(tabId)
  return el
}

function scrollToBottom(tabId) {
  const tab = tabs.get(tabId || activeTabId)
  if (tab) requestAnimationFrame(() => tab.messagesEl.scrollTop = tab.messagesEl.scrollHeight)
}

function esc(s) {
  if (typeof s !== 'string') s = String(s || '')
  const d = document.createElement('div')
  d.textContent = s
  return d.innerHTML
}

function autoResize() {
  inputEl.style.height = 'auto'
  inputEl.style.height = Math.min(inputEl.scrollHeight, 150) + 'px'
}
inputEl.addEventListener('input', autoResize)

inputEl.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey && !e.isComposing) {
    e.preventDefault()
    sendMessage()
  }
})

init()
</script>
</body>
</html>
