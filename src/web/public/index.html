<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Claude Code</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0d1117;--surface:#161b22;--border:#30363d;
  --text:#e6edf3;--muted:#8b949e;--accent:#58a6ff;
  --warning:#d29922;--danger:#f85149;--success:#3fb950;
  --radius:12px;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:-apple-system,system-ui,sans-serif;font-size:15px}
body{display:flex;flex-direction:column;height:100dvh}

/* ヘッダー */
.header{display:flex;align-items:center;gap:8px;padding:12px 16px;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0}
.header h1{font-size:16px;font-weight:600;flex:1}
.header select{background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:4px 8px;font-size:13px}

/* メッセージエリア */
.messages{flex:1;overflow-y:auto;padding:16px;-webkit-overflow-scrolling:touch}
.msg{margin-bottom:16px;max-width:100%}
.msg.user .bubble{background:var(--accent);color:#fff;border-radius:var(--radius) var(--radius) 4px var(--radius);margin-left:40px;padding:10px 14px;word-break:break-word}
.msg.assistant .bubble{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius) var(--radius) var(--radius) 4px;margin-right:20px;padding:12px 14px;word-break:break-word}
.msg.assistant .bubble pre{background:#0d1117;border:1px solid var(--border);border-radius:8px;padding:10px;overflow-x:auto;margin:8px 0;font-size:13px}
.msg.assistant .bubble code{font-family:'SF Mono',Menlo,monospace;font-size:13px}
.msg.assistant .bubble p code{background:rgba(110,118,129,.4);padding:2px 6px;border-radius:4px}
.msg.assistant .bubble p{margin:6px 0}
.msg.assistant .bubble ul,.msg.assistant .bubble ol{padding-left:20px;margin:6px 0}

/* ツール使用表示 */
.tool-badge{display:inline-flex;align-items:center;gap:4px;background:rgba(88,166,255,.15);color:var(--accent);border-radius:6px;padding:3px 8px;font-size:12px;margin:4px 4px 4px 0}

/* 危険コマンド警告 */
.warning-badge{display:flex;align-items:center;gap:6px;background:rgba(210,153,34,.15);color:var(--warning);border:1px solid rgba(210,153,34,.3);border-radius:8px;padding:8px 12px;font-size:13px;margin:8px 0}

/* コスト表示 */
.meta{font-size:12px;color:var(--muted);margin-top:6px;display:flex;gap:12px}

/* 入力エリア */
.input-area{border-top:1px solid var(--border);background:var(--surface);padding:12px 16px;padding-bottom:calc(12px + env(safe-area-inset-bottom));flex-shrink:0}
.input-row{display:flex;gap:8px;align-items:flex-end}
.input-row textarea{flex:1;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);padding:10px 14px;font-size:15px;font-family:inherit;resize:none;min-height:44px;max-height:120px;line-height:1.4}
.input-row textarea:focus{outline:none;border-color:var(--accent)}
.input-row button{width:44px;height:44px;border:none;border-radius:50%;background:var(--accent);color:#fff;font-size:20px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center}
.input-row button:disabled{opacity:.4;cursor:not-allowed}

/* ローディング */
.typing{display:flex;gap:4px;padding:6px 0}
.typing span{width:6px;height:6px;background:var(--muted);border-radius:50%;animation:bounce .6s infinite alternate}
.typing span:nth-child(2){animation-delay:.2s}
.typing span:nth-child(3){animation-delay:.4s}
@keyframes bounce{to{opacity:.3;transform:translateY(-4px)}}

/* プロジェクト選択ドロワー */
.drawer{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:10;display:none}
.drawer.open{display:block}
.drawer-content{position:absolute;bottom:0;left:0;right:0;background:var(--surface);border-radius:16px 16px 0 0;padding:20px 16px;padding-bottom:calc(20px + env(safe-area-inset-bottom));max-height:60vh;overflow-y:auto}
.drawer-content h2{font-size:16px;margin-bottom:12px}
.project-item{display:flex;flex-direction:column;padding:12px;border:1px solid var(--border);border-radius:var(--radius);margin-bottom:8px;cursor:pointer}
.project-item:hover,.project-item.active{border-color:var(--accent);background:rgba(88,166,255,.08)}
.project-item .name{font-weight:600;font-size:14px}
.project-item .path{font-size:12px;color:var(--muted);margin-top:2px}
</style>
</head>
<body>

<div class="header">
  <h1 id="title">Claude Code</h1>
  <select id="model">
    <option value="sonnet">Sonnet</option>
    <option value="opus">Opus</option>
    <option value="haiku">Haiku</option>
  </select>
  <button style="background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer" onclick="openDrawer()">&#9776;</button>
</div>

<div class="messages" id="messages"></div>

<div class="input-area">
  <div class="input-row">
    <textarea id="input" rows="1" placeholder="Claude に指示を送る..." enterkeyhint="send"></textarea>
    <button id="send" onclick="sendMessage()">&#9654;</button>
  </div>
</div>

<div class="drawer" id="drawer" onclick="closeDrawer()">
  <div class="drawer-content" onclick="event.stopPropagation()">
    <h2>Projects</h2>
    <div id="projectList"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked@15/marked.min.js"></script>
<script>
// --- State ---
let sessionId = null
let currentProject = null
let sending = false
const messagesEl = document.getElementById('messages')
const inputEl = document.getElementById('input')
const sendBtn = document.getElementById('send')

// --- 初期化 ---
async function init() {
  try {
    const res = await fetch('/api/projects', { credentials: 'include' })
    const projects = await res.json()
    const list = document.getElementById('projectList')
    list.innerHTML = ''
    projects.forEach(p => {
      const el = document.createElement('div')
      el.className = 'project-item' + (currentProject === p.localPath ? ' active' : '')
      el.innerHTML = `<span class="name">${esc(p.slug)}</span><span class="path">${esc(p.localPath)}</span>`
      el.onclick = () => { selectProject(p); closeDrawer() }
      list.appendChild(el)
    })
    if (!currentProject && projects.length > 0) selectProject(projects[0])
  } catch (e) {
    console.error('Failed to load projects:', e)
  }
}

function selectProject(p) {
  currentProject = p.localPath
  sessionId = null
  document.getElementById('title').textContent = p.slug
}

function openDrawer() { document.getElementById('drawer').classList.add('open') }
function closeDrawer() { document.getElementById('drawer').classList.remove('open') }

// --- メッセージ送信 ---
async function sendMessage() {
  const text = inputEl.value.trim()
  if (!text || sending) return
  sending = true
  sendBtn.disabled = true
  inputEl.value = ''
  autoResize()

  addMessage('user', text)
  const assistantEl = addMessage('assistant', '')
  const bubble = assistantEl.querySelector('.bubble')
  bubble.innerHTML = '<div class="typing"><span></span><span></span><span></span></div>'

  let fullText = ''

  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        message: text,
        project: currentProject,
        sessionId,
        model: document.getElementById('model').value,
      }),
    })

    const reader = res.body.getReader()
    const decoder = new TextDecoder()
    let buffer = ''

    while (true) {
      const { done, value } = await reader.read()
      if (done) break
      buffer += decoder.decode(value, { stream: true })

      // SSEフォーマット: "event: xxx\ndata: yyy\n\n" をパース
      const blocks = buffer.split('\n\n')
      buffer = blocks.pop() || ''

      for (const block of blocks) {
        if (!block.trim()) continue
        let eventName = 'message'
        let data = ''
        for (const line of block.split('\n')) {
          if (line.startsWith('event:')) eventName = line.slice(6).trim()
          else if (line.startsWith('data:')) data = line.slice(5).trimStart()
        }
        if (data) handleSSE(eventName, data, bubble, assistantEl)
      }
    }
  } catch (e) {
    bubble.innerHTML = `<span style="color:var(--danger)">Error: ${esc(e.message)}</span>`
  }

  sending = false
  sendBtn.disabled = false
  scrollToBottom()
}

function handleSSE(event, data, bubble, msgEl) {
  if (event === 'text') {
    // タイピングアニメーション除去
    const typing = bubble.querySelector('.typing')
    if (typing) typing.remove()

    // テキスト蓄積 + マークダウンレンダリング
    if (!bubble._fullText) bubble._fullText = ''
    bubble._fullText += data
    bubble.innerHTML = marked.parse(bubble._fullText)
    scrollToBottom()
  }

  if (event === 'tool') {
    try {
      const info = JSON.parse(data)
      if (info.status === 'start') {
        let toolsRow = bubble.querySelector('.tools-row')
        if (!toolsRow) { toolsRow = document.createElement('div'); toolsRow.className = 'tools-row'; bubble.prepend(toolsRow) }
        toolsRow.innerHTML += `<span class="tool-badge">${esc(info.name)}</span>`
      }
    } catch {}
  }

  if (event === 'warning') {
    try {
      const w = JSON.parse(data)
      const warn = document.createElement('div')
      warn.className = 'warning-badge'
      warn.innerHTML = `&#9888; <strong>${esc(w.label)}</strong> ${esc(w.command)}`
      bubble.appendChild(warn)
      scrollToBottom()
    } catch {}
  }

  if (event === 'session') {
    try {
      const s = JSON.parse(data)
      if (s.sessionId) sessionId = s.sessionId
    } catch {}
  }

  if (event === 'result') {
    try {
      const r = JSON.parse(data)
      if (r.sessionId) sessionId = r.sessionId
      // resultのテキストがあり、まだ表示されていない場合
      if (r.text && !bubble._fullText) {
        bubble.innerHTML = marked.parse(r.text)
      }
      // メタ情報
      if (r.cost || r.durationMs) {
        const meta = document.createElement('div')
        meta.className = 'meta'
        if (r.cost) meta.innerHTML += `<span>$${r.cost.toFixed(4)}</span>`
        if (r.durationMs) meta.innerHTML += `<span>${(r.durationMs / 1000).toFixed(1)}s</span>`
        if (r.turns) meta.innerHTML += `<span>${r.turns} turns</span>`
        msgEl.appendChild(meta)
      }
    } catch {}
  }

  if (event === 'error') {
    try {
      const e = JSON.parse(data)
      bubble.innerHTML = `<span style="color:var(--danger)">Error: ${esc(e.message)}</span>`
    } catch {}
  }
}

// --- UI helpers ---
function addMessage(role, text) {
  const el = document.createElement('div')
  el.className = `msg ${role}`
  el.innerHTML = `<div class="bubble">${role === 'user' ? esc(text) : text}</div>`
  messagesEl.appendChild(el)
  scrollToBottom()
  return el
}

function scrollToBottom() {
  requestAnimationFrame(() => messagesEl.scrollTop = messagesEl.scrollHeight)
}

function esc(s) {
  const d = document.createElement('div')
  d.textContent = s
  return d.innerHTML
}

// テキストエリア自動リサイズ
function autoResize() {
  inputEl.style.height = 'auto'
  inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + 'px'
}
inputEl.addEventListener('input', autoResize)

// Enter送信 (Shift+Enterで改行)
inputEl.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey && !e.isComposing) {
    e.preventDefault()
    sendMessage()
  }
})

// 起動
init()
</script>
</body>
</html>
